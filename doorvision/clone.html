<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="css/style.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <title>Document</title>

    <style>
      ul li {
        list-style-type: none;
      }
      .create_img {
        padding: 10px;
      }
      .createGrid ul {
        display: flex;
      }
      .create_img > ul > li {
        position: relative;
      }
      .createImageimg {
        display: flex;
        position: relative;
      }
      .append_grid {
        position: relative;
      }
      .bg_img_main,
      .bg_img_main_canvas {
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
      }
      .bg_img_main_canvas {
        z-index: 0 !important;
      }
      .append_grid_for_selection ul {
        gap: 1px;
      }
      .append_grid_for_selection ul li {
        flex: 1;
        width: 80px;
        height: 65px;
      }
      .append_grid_for_selection ul li.i_am_selected {
        border-color: #0d6efd;
      }
      .append_grid_for_selection ul li {
        border: 2px solid #d1d1d1;
      }

      .window_img {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: calc(100% - 16px);
        height: calc(100% - 16px);
        z-index: 10;
      }
      .window_img img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .window_img canvas {
        position: absolute;
        z-index: 1;
        left: -1px;
        right: -1px;
        top: -1px;
        bottom: -1px;
        width: calc(100% + 2px);
        height: calc(100% + 2px);
      }

      .image_grid_parent.append_grid {
        display: block !important;
      }
    </style>
  </head>
  <body>
    <!-- <div class="contact_row">
      <div class="contact_col_2">
        <div class="contact_col_inr">
          <label> First Name [text* first-name] </label>
        </div>
      </div>

      <div class="contact_col_2">
        <div class="contact_col_inr">
          <label> Last Name [text* Last-name] </label>
        </div>
      </div>

      <div class="contact_col_2">
        <div class="contact_col_inr">
          <label> Your email [email* your-email autocomplete:email] </label>
        </div>
      </div>

      <div class="contact_col_2">
        <div class="contact_col_inr">
          <label> Subject [text* your-subject] </label>
        </div>
      </div>

      <div class="contact_col_2">
        <div class="contact_col_inr">
          <label> Your message (optional) [textarea your-message] </label>
        </div>
      </div>

      <div class="contact_col_2 submit_btn">
        <div class="contact_col_inr">[submit "Submit"]</div>
      </div>
    </div> -->

    <header class="shadow">
      <div class="header_logo">
        <a href="index.html">
          <img src="./images/DoorMaster-Logo-CMYK.png" alt="" />
        </a>
      </div>
    </header>
    <main class="mx-auto px-1">
      <div class="product_main">
        <div class="left_section_col shadow-lg bg-white mx-2">
          <div class="left_section_inr p-3 scroll-css">
            <div class="image_grid_parent append_grid">
              <div class="createGrid create_img"></div>
              <img class="bg_img_main" src="./images/white_img_for_bg.png" />
              <canvas class="bg_img_main_canvas"></canvas>
            </div>
          </div>
        </div>
        <div class="right_section_col shadow-lg bg-white">
          <div class="right_section_inr scroll-css">
            <div
              class="d-flex align-items-center justify-content-center grid_main_row"
            >
              <div class="for_all_grid grid_buttons">
                <ul></ul>
              </div>
              <div class="createGrid append_grid_for_selection"></div>
              <div class="for_grid_height grid_buttons">
                <ul></ul>
              </div>
            </div>
          </div>
          <button
            id="grid_submit_btn"
            class="btn btn-success px-5 mt-4 text-uppercase fw-medium"
          >
            Add
          </button>

          <div id="select_color" class="select_color small_list">
            <ul>
              <li data-color="#ebeeee">
                <span style="background-color: rgb(235, 238, 238)"></span>
                <p>white</p>
              </li>
              <li data-color="#d6cdbe">
                <span style="background-color: rgb(214, 205, 190)"></span>
                <p>Almond</p>
              </li>
              <li data-color="#a09387">
                <span style="background-color: rgb(160, 147, 135)"></span>
                <p>Sandstone</p>
              </li>
              <li data-color="#4b3933">
                <span style="background-color: rgb(75, 57, 51)"></span>
                <p>Brown</p>
              </li>
              <li data-color="#004932">
                <span style="background-color: rgb(0, 73, 50)"></span>
                <p>Evergreen</p>
              </li>
              <li data-color="#706d69">
                <span style="background-color: rgb(112, 109, 105)"></span>
                <p>bronze</p>
              </li>
              <li data-color="#9e9fa3">
                <span style="background-color: rgb(158, 159, 163)"></span>
                <p>gray</p>
              </li>
              <li data-color="#cdc5b0">
                <span style="background-color: rgb(205, 197, 176)"></span>
                <p>desert tan</p>
              </li>
              <li data-color="#231f20">
                <span style="background-color: rgb(35, 31, 32)"></span>
                <p>black</p>
              </li>
              <li data-color="#3d4045">
                <span style="background-color: rgb(61, 64, 69)"></span>
                <p>Graphite</p>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <button id="downloadButton">download button</button>
    </main>

    <script src="js/jquery-3.6.0.min.js" type="text/javascript"></script>

    <script>
      // let hexColor = "#d6cdbe";
      let numberOfRow = 4;
      let numberOfColumn = 1;
      let heightQuantity = [21, 21, 21, 21];

      var selectedOpacity = 0.85;
      var my_color = null;

      for (let i = 0; i < numberOfRow; i++) {
        // this is for create row in img
        document.querySelectorAll(".create_img").forEach((a) => {
          a.insertAdjacentHTML("beforeend", `<ul rowIndex = ${i}> </ul>`);
        });
        // this is create grid row
        document.querySelectorAll(".append_grid_for_selection").forEach((a) => {
          a.insertAdjacentHTML("beforeend", `<ul rowIndex = ${i}> </ul>`);
        });

        document
          .querySelector(".for_all_grid ul")
          .insertAdjacentHTML("beforeend", `<li> <span>All</span></li>`);
        document
          .querySelector(".for_grid_height ul")
          .insertAdjacentHTML(
            "beforeend",
            `<li><span>${heightQuantity[i]}</span> </li>`
          );
      }

      for (let j = 0; j < numberOfColumn; j++) {
        // this is for create image
        document.querySelectorAll(".create_img ul").forEach((b) => {
          b.insertAdjacentHTML(
            "beforeend",
            `<li listindex = ${j}>
                        <div class="createImageimg">
                            <img class="" src="./images/stampped_short.jpeg">
                            <canvas class="myCanvas"><canvas>
                        </div>
                        <div class="window_img"> </div>
                    </li>`
          );
        });

        // this is for selection grid columns
        document
          .querySelectorAll(".append_grid_for_selection ul")
          .forEach((b) => {
            b.insertAdjacentHTML("beforeend", `<li listindex = ${j}> </li>`);
          });
      }

      $(".append_grid_for_selection ul li").on("click", function () {
        $(".append_grid_for_selection ul li").removeClass("i_am_selected");
        $(this).toggleClass("i_am_selected");

        $(".for_all_grid.grid_buttons ul li span").removeClass("selected");
        $(".for_all_grid.grid_buttons ul li")
          .eq($(this).parent("ul").attr("rowindex"))
          .find("span")
          .addClass("selected");
      });

      let arrForGridDataRow = [];
      let arrForGridDataColumn = [];

      $("#grid_submit_btn").on("click", function () {
        arrForGridDataRow.splice(0, arrForGridDataRow.length);
        arrForGridDataColumn.splice(0, arrForGridDataColumn.length);

        $(".append_grid_for_selection ul").each(function (index) {
          if ($(this).find("li.i_am_selected").length > 0) {
            let row_index = this.getAttribute("rowIndex");
            if (!arrForGridDataRow.includes(row_index)) {
              arrForGridDataRow.push(row_index);
            }
          }
        });
        // arrForGridDataRow.sort();

        for (j = 0; j < arrForGridDataRow.length; j++) {
          let for_column = [];
          document
            .querySelectorAll(".append_grid_for_selection ul")
            [arrForGridDataRow[j]].querySelectorAll("li.i_am_selected")
            .forEach((e) => {
              for_column.push(e.getAttribute("listindex"));
            });

          arrForGridDataColumn.push(for_column);
        }

        // for insert window

        $(".create_img ul li .window_img").empty();

        for (let i = 0; i < arrForGridDataRow.length; i++) {
          for (let j = 0; j < arrForGridDataColumn[i].length; j++) {
            document
              .querySelectorAll(".create_img ul")
              [arrForGridDataRow[i]].querySelectorAll("li")
              [arrForGridDataColumn[i][j]].querySelector(".window_img")
              .insertAdjacentHTML(
                "beforeend",
                ` <img src="./images/window/White_long_plain.png" >
                <canvas class="windowCanavas"></canvas> `
              );
          }
        }

        if ($(".create_img ul li").find(".window_img").length > 0) {
          applyColorOverlaywindow(my_color);
          setTimeout(applyColorOverlaywindow, 100, my_color);
        }
      });

      // for all

      document.querySelectorAll(".for_all_grid ul li span").forEach((a, x) => {
        a.addEventListener("click", function () {
          document.querySelectorAll(".for_all_grid ul li span").forEach((e) => {
            e.classList.remove("selected");
          });

          if (this.className == "selected") {
            $(".append_grid_for_selection ul li").removeClass("i_am_selected");

            this.classList.remove("selected");
            document
              .querySelectorAll(".append_grid_for_selection ul")
              [x].querySelectorAll("li")
              .forEach((lists) => {
                lists.classList.remove("i_am_selected");
              });
          } else {
            $(".append_grid_for_selection ul li").removeClass("i_am_selected");

            this.classList.add("selected");
            document
              .querySelectorAll(".append_grid_for_selection ul")
              [x].querySelectorAll("li")
              .forEach((lists) => {
                lists.classList.add("i_am_selected");
              });
          }
        });
      });

      // click on color

      $("#select_color ul li").on("click", function () {
        my_color = $(this).attr("data-color");

        applyColorOverlay_multiple(my_color);
        applyColorOverlay(my_color);

        // const rgbaColor = hexToRgba(my_color, selectedOpacity);
        // document.querySelector(".create_img").style.backgroundColor = rgbaColor;

        if ($(".create_img ul li").find(".window_img").length > 0) {
          applyColorOverlaywindow(my_color);
        }
      });

      // hex to rgba
      function hexToRgba(hex, opacity) {
        hex = hex.replace(/^#/, "");
        const r = parseInt(hex.substring(0, 2), 16);
        const g = parseInt(hex.substring(2, 4), 16);
        const b = parseInt(hex.substring(4, 6), 16);
        opacity = Math.min(1, Math.max(0, opacity));
        const rgba = `rgba(${r}, ${g}, ${b}, ${opacity})`;
        return rgba;
      }

      function applyColorOverlay(my_color) {
        var canvas = document.querySelector(".bg_img_main_canvas");
        var ctx = canvas.getContext("2d");
        var image = document.querySelector(".bg_img_main");

        canvas.width = image.width;
        canvas.height = image.height;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

        var selectedColor = my_color;

        ctx.globalCompositeOperation = "multiply";
        ctx.fillStyle = `rgba(${parseInt(
          selectedColor.slice(1, 3),
          16
        )}, ${parseInt(selectedColor.slice(3, 5), 16)}, ${parseInt(
          selectedColor.slice(5, 7),
          16
        )}, ${selectedOpacity})`;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.globalCompositeOperation = "source-over";
      }

      function applyColorOverlay_multiple(my_color) {
        document.querySelectorAll(".myCanvas").forEach((e) => {
          var ctx = e.getContext("2d");
          var image = document.querySelector(".createImageimg img");

          e.width = image.width;
          e.height = image.height;

          ctx.clearRect(0, 0, e.width, e.height);
          ctx.drawImage(image, 0, 0, e.width, e.height);

          var selectedColor = my_color;

          ctx.globalCompositeOperation = "multiply";
          ctx.fillStyle = `rgba(${parseInt(
            selectedColor.slice(1, 3),
            16
          )}, ${parseInt(selectedColor.slice(3, 5), 16)}, ${parseInt(
            selectedColor.slice(5, 7),
            16
          )}, ${selectedOpacity})`;
          ctx.fillRect(0, 0, e.width, e.height);
          ctx.globalCompositeOperation = "source-over";
        });
      }

      function applyColorOverlaywindow(my_color) {
        document.querySelectorAll(".window_img canvas").forEach((e) => {
          var ctx = e.getContext("2d");
          var image = document.querySelector(".window_img img");

          e.width = image.width;
          e.height = image.height;

          ctx.clearRect(0, 0, e.width, e.height);
          ctx.drawImage(image, 0, 0, e.width, e.height);

          var selectedColor = my_color;

          ctx.globalCompositeOperation = "multiply";
          ctx.fillStyle = `rgba(${parseInt(
            selectedColor.slice(1, 3),
            16
          )}, ${parseInt(selectedColor.slice(3, 5), 16)}, ${parseInt(
            selectedColor.slice(5, 7),
            16
          )}, ${selectedOpacity})`;
          ctx.fillRect(0, 0, e.width, e.height);
          ctx.globalCompositeOperation = "source-over";
        });
      }

      const downloadButton = document.getElementById("downloadButton");
      const divToCapture = document.querySelector(
        ".image_grid_parent.append_grid"
      );

      downloadButton.addEventListener("click", () => {
        domtoimage
          .toBlob(divToCapture)
          .then(function (blob) {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "captured_image.png";

            a.click();

            URL.revokeObjectURL(a.href);
          })
          .catch(function (error) {
            console.error("Error capturing image:", error);
          });
      });

      // downloadButton.addEventListener('click', function () {

      //   html2canvas(divToCapture).then( function(canvas) {

      //     const dataUrl =  canvas.toDataURL('image/jpg');

      //     const link = document.createElement('a');
      //     link.href = dataUrl;
      //     link.download = 'section_image.jpg';

      //     link.click();

      //     });
      //   });

      // height old API

      // $.ajax({
      //         url: `${path_of_site}DoorVisulization/GetVisulizationModelHeightSection`,
      //         type: 'POST',
      //         contentType: 'application/json-patch+json',
      //         dataType: 'json',
      //         data: `{
      //             doorHeight:${dataForPostObj.doorHeight},
      //             doorWidth: ${dataForPostObj.doorWidth},
      //             doorTypeId: ${dataForPostObj.doorTypeId},
      //             doorCompanyId: ${dataForPostObj.doorCompanyId}}`,
      //         headers: {
      //             'Authorization':'Bearer ' + token,
      //         },
      //         success: function(data) {

      //              JSON.stringify(data);

      //              document.querySelector("#model_number_row").innerHTML = null;
      //              $("#model_number_row").siblings('.error').text('');
      //             if(data.payload.length < 1 || data.payload == undefined){
      //                 $("#model_number_row").siblings('.error').text('data not found');
      //             }
      //             else{
      //                  data.payload.forEach((e, index)=>{
      //                    document.querySelector("#model_number_row").insertAdjacentHTML('beforeend',
      //                        `<div class="model_number_col p-2 bg-light" data-index="${index}" doorModelId="${e.doorModelId}" doorSalePrice="${e.doorSalePrice}" doorModelPath="${e.doorModelPath}" doorModelDesc='${e.doorModelDesc}' noOfSection="${e.noOfSection}">
      //                        <div class="model_number_col_inr text-center h-100 d-flex">
      //                            <p class="mb-1 fs-6 model_num">${e.doorModelName}</p>
      //                            <span class="quality_of_model px-2 py-1 text-bg-secondary text-white text-capitalize fw-semibold">Best</span>
      //                            <p class="mb-1 fs-6"> R-17-19</p>
      //                        </div>
      //                    </div>`);

      //                  });

      //             $("#model_number_row").siblings('.error').text('');
      //            page_loader.hide();

      //          $('.model_number_col').mouseenter(function(){
      //             $('.modelDesc').text($(this).attr("doorModelDesc"));
      //             $('#model_number_img img').attr("src", $(this).attr("doorModelPath"));
      //         });

      //         $('.model_number_col').mouseleave(function(){
      //             $('.modelDesc').text($(this).siblings('.selected').attr(("doorModelDesc")));
      //             $('#model_number_img img').attr("src", $(this).siblings('.selected').attr(("doorModelPath")));
      //         });

      //         $('.model_number_col').click(function(){

      //             $('.model_number_col').removeClass('selected');
      //             $(this).addClass('selected');
      //             $('.modelDesc').text($(this).attr("doorModelDesc"));
      //             $('#model_number_img img').attr("src", $(this).attr("doorModelPath"));

      //             $('#model_number_for_quatation').text($(this).find(".model_num").text());

      //             doorModelId = $(this).attr('doorModelId');
      //             let clickedThis = $(this);
      //             let colorArr = data.payload[$(this).attr('data-index')].lstDoorColor;

      //             if(doorPanelId == null || doorModelId == null){

      //                 (doorPanelId == null)?alert("please select panel type"):'';
      //                 (doorModelId == null)?alert("please select Model"):'';

      //             }
      //             else{
      //             calledDataForImageCreate(clickedThis, colorArr);

      //             }

      //         });

      //         }

      //         },
      //         error: function(xhr, status, error) {
      //             document.querySelector('#model_number_row').innerHTML = null;
      //             document.querySelector('#model_number_row').insertAdjacentHTML('beforeend', `<span class="text-danger" > 'Error: ' ${error} </span>`);

      //            page_loader.hide();

      //         }
      //     });

      // model click function

      // if(dataForPostObj.doorWidth == null || doorCompanyId == null|| doorPanelId == null || doorModelId == null){
      //     alert('please select Model');
      // }
      // else{

      //     console.log(dataForPostObj.doorWidth, doorCompanyId, doorPanelId, doorModelId);
      // page_loader.show();
      // $.ajax({
      //     url: `${path_of_site}DoorVisulization/GetVisulizationWidhtSection`,
      //     type: 'POST',
      //     contentType: 'application/json-patch+json',
      //     dataType: 'json',
      //     data: `{
      //         doorWidth:${dataForPostObj.doorWidth},
      //         doorCompanyId:${doorCompanyId},
      //         doorPanelId: ${doorPanelId},
      //         doorModelId:${doorModelId},
      //         }`,
      //     headers: {
      //         'Authorization':'Bearer ' + token,
      //     },
      //     success:  function(data) {
      //         JSON.stringify(data);

      //         if(data.payload.length < 1 || data.payload[0].noOfSection == null ){

      //             page_loader.hide();
      //             alert("Data not found");

      //         }
      //         else if(data.payload[0].repeatedFile == undefined || data.payload[0].repeatedFile == null){

      //             alert("Image not found");

      //         }
      //         else{

      //             $('.your_door_design').hide();
      //             $('.image_grid_parent.append_grid').show();
      //             $('.left_btns').show();

      //             let numberOfColumn =  data.payload[0].noOfSection;
      //             repeatedFile =  data.payload[0].repeatedFile;

      //             createImageRowColumn(clickedThis, numberOfColumn, repeatedFile, colorArr);

      //         }

      //         page_loader.hide();
      //     },
      //     error: function(xhr, status, error) {
      //         document.querySelector('#model_number_row .error').text('');
      //         document.querySelector('#model_number_row .error').text(`Error: ${error}`);
      //         page_loader.hide();
      //     }
      // });
      // // }
    </script>
  </body>
</html>
